# Implementation Plan

## 概要

ローカルストレージ保存機能の実装タスク。セッション履歴の保存、中断セッションの復元、ユーザー設定の永続化、およびストレージ容量管理を実現する。

---

- [x] 1. ストレージユーティリティ層の構築
- [x] 1.1 ストレージ型定義とエラー型の作成
  - セッション履歴エントリの型を定義する（ID、完了日時、ラウンド数、メモ配列）
  - ユーザー設定の型を定義する（繰り返し回数）
  - ストレージ操作結果の型を定義する（成功/失敗のユニオン型）
  - ストレージエラー種別を定義する（容量超過、パースエラー、利用不可）
  - ストレージキー定数と容量制限定数を定義する
  - _Requirements: 4.1, 4.2_

- [x] 1.2 基本ストレージ操作関数の実装
  - localStorageの利用可否を判定する機能を実装する
  - JSONシリアライズによるデータ保存機能を実装する
  - JSONデシリアライズによるデータ読み込み機能を実装する
  - 指定キーのデータ削除機能を実装する
  - パースエラー時のフォールバック処理を実装する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 1.3 ストレージユーティリティのユニットテスト作成
  - 正常系の保存・読み込み・削除操作をテストする
  - JSON parse/stringifyエラー発生時の動作をテストする
  - localStorage利用不可時のフォールバックをテストする
  - 破損データ検出時のエラーハンドリングをテストする
  - _Requirements: 4.3, 4.4_

---

- [x] 2. セッション履歴管理機能の実装
- [x] 2.1 セッション履歴の保存・読み込み機能の実装
  - 完了したセッションを履歴として保存する機能を実装する
  - 保存時に一意のIDと完了日時を自動付与する
  - 保存済み履歴の一覧を読み込む機能を実装する
  - 履歴データのバリデーションを実装する
  - _Requirements: 1.1, 1.2, 1.4_

- [x] 2.2 履歴件数制限と容量管理の実装
  - 最大10件の履歴制限を適用し、古いものから自動削除する
  - 容量超過エラー発生時に古い履歴を削除して再試行する
  - 再試行でも失敗した場合のエラー通知機能を実装する
  - _Requirements: 1.3, 5.1, 5.2, 5.3_

- [x] 2.3 セッション履歴機能のユニットテスト作成
  - 履歴保存と読み込みの正常系をテストする
  - 10件制限の適用と古い履歴の削除をテストする
  - QuotaExceededError発生時の再試行動作をテストする
  - _Requirements: 1.1, 1.2, 1.3, 5.1, 5.2_

---

- [x] 3. ユーザー設定永続化機能の実装
- [x] 3.1 設定の保存・読み込み機能の実装
  - 繰り返し回数設定を即座に保存する機能を実装する
  - アプリ起動時に保存済み設定を読み込む機能を実装する
  - 設定が存在しない場合のデフォルト値適用を実装する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 3.2 設定機能のユニットテスト作成
  - 設定保存の即時反映をテストする
  - 保存設定の読み込みをテストする
  - デフォルト値フォールバックをテストする
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

---

- [x] 4. 中断セッション機能の強化
- [x] 4.1 既存中断セッション機能のリファクタリング
  - 既存のlocalStorage直接操作をストレージユーティリティ経由に置き換える
  - 自動保存の動作を維持しつつ、新しいインターフェースに統合する
  - セッション完了・リセット時の中断データ削除を維持する
  - _Requirements: 2.1, 2.5_

- [x] 4.2 中断セッション復元の検証と改善
  - 中断時点のラウンドとフェーズから正確に復元することを確認する
  - 再開選択時と新規開始選択時の動作を検証する
  - 破損した中断データの検出と削除を実装する
  - _Requirements: 2.2, 2.3, 2.4_

- [x] 4.3 中断セッション機能のテスト強化
  - 自動保存タイミングの正確性をテストする
  - 復元時の状態整合性をテストする
  - ResumeDialogとの連携動作をテストする
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

---

- [x] 5. useStorageフックの実装
- [x] 5.1 Reactストレージフックの実装
  - ストレージユーティリティをラップするカスタムフックを作成する
  - 履歴・設定・中断セッションの状態管理をフックで提供する
  - ストレージ利用可否の判定とエラー状態の管理を実装する
  - 保存操作の成功/失敗を呼び出し元に返す機能を実装する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 5.2 useStorageフックのテスト作成
  - フック初期化時の状態読み込みをテストする
  - 保存操作後の状態更新をテストする
  - エラー発生時の状態管理をテストする
  - _Requirements: 4.3, 4.4_

---

- [x] 6. useSessionフックの拡張と統合
- [x] 6.1 useSessionとuseStorageの統合
  - useSessionフック内でuseStorageを使用するよう変更する
  - セッション完了時に履歴を自動保存する機能を追加する
  - 設定変更時に即座に永続化する機能を追加する
  - 後方互換性を維持しつつ新機能を追加する
  - _Requirements: 1.1, 3.1, 3.4_

- [x] 6.2 アプリ起動時の初期化フロー実装
  - 起動時に保存された設定を読み込み、初期値として適用する
  - 中断セッション検出と再開ダイアログの表示を連携する
  - 設定読み込み完了状態を提供する
  - _Requirements: 1.4, 2.2, 3.2_

- [x] 6.3 useSession拡張のテスト作成
  - セッション完了時の履歴保存をテストする
  - 設定変更の永続化をテストする
  - 初期化時の設定読み込みをテストする
  - useStorageとの統合動作をテストする
  - _Requirements: 1.1, 2.1, 3.1, 3.2_

---

- [x] 7. 結合テストとエッジケース対応
- [x] 7.1 完全フロー結合テストの作成
  - セッション完了から履歴保存、読み込みまでの一連の流れをテストする
  - 設定変更から永続化、再読み込みまでの一連の流れをテストする
  - 中断から再開までの完全な復元フローをテストする
  - _Requirements: 1.1, 1.4, 2.3, 3.2_

- [x] 7.2 エラーケースと境界条件のテスト
  - localStorage利用不可環境での正常動作をテストする
  - 容量超過時の段階的削除と再試行をテストする
  - 破損データ検出時のフォールバック動作をテストする
  - 複数タブでの同時操作シナリオを検討する
  - _Requirements: 4.3, 4.4, 5.2, 5.3_

---

## 要件カバレッジマトリクス

| 要件ID | タスク |
|--------|--------|
| 1.1 | 2.1, 6.1, 7.1 |
| 1.2 | 2.1, 2.3 |
| 1.3 | 2.2, 2.3 |
| 1.4 | 2.1, 6.2, 7.1 |
| 2.1 | 4.1, 4.3, 6.3 |
| 2.2 | 4.2, 6.2 |
| 2.3 | 4.2, 7.1 |
| 2.4 | 4.2, 4.3 |
| 2.5 | 4.1, 4.3 |
| 3.1 | 3.1, 6.1, 6.3 |
| 3.2 | 3.1, 3.2, 6.2, 6.3, 7.1 |
| 3.3 | 3.1, 3.2 |
| 3.4 | 3.1, 3.2, 6.1 |
| 4.1 | 1.1, 1.2, 5.1 |
| 4.2 | 1.1, 1.2, 5.1 |
| 4.3 | 1.2, 1.3, 5.1, 5.2, 7.2 |
| 4.4 | 1.2, 1.3, 5.1, 5.2, 7.2 |
| 4.5 | 1.2 |
| 5.1 | 2.2, 2.3 |
| 5.2 | 2.2, 7.2 |
| 5.3 | 2.2, 7.2 |
