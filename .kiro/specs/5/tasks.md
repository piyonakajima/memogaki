# Implementation Plan

## 概要

セッション管理機能の実装タスク。書き出しモードと読み返しモードを統合し、繰り返し回数に基づいたセッションフローを制御する。

---

- [x] 1. セッション管理の型定義とデータモデルを作成する
  - セッションのフェーズを表す型を定義する（設定、書き出し、読み返し、完了、再開確認）
  - 1ラウンドのメモデータ構造を定義する（ラウンド番号、元テキスト、追記、統合テキスト、作成日時）
  - セッション全体の状態を表す型を定義する（フェーズ、現在ラウンド、総ラウンド数、メモ配列、一時テキスト）
  - 状態更新のアクション型を定義する
  - 中断セッション保存用のデータ構造を定義する
  - デフォルト値と定数を定義する（デフォルト10回、最小1回、最大99回、ストレージキー）
  - _Requirements: 1.2, 1.3, 3.3, 3.4, 3.5, 3.6_

- [x] 2. セッション状態管理フックを実装する
- [x] 2.1 基本的な状態管理ロジックを実装する
  - 初期状態を定義する（設定フェーズ、ラウンド1、デフォルト回数）
  - 繰り返し回数を変更する機能を実装する（1-99の範囲でバリデーション）
  - セッションを開始する機能を実装する（書き出しフェーズへ遷移、状態初期化）
  - 書き出し完了時の処理を実装する（テキスト保存、読み返しフェーズへ遷移）
  - 読み返し完了時の処理を実装する（メモ統合、ラウンド進行または完了判定）
  - セッションをリセットする機能を実装する（設定フェーズへ戻る）
  - 最終ラウンド判定のロジックを実装する
  - _Requirements: 1.1-1.5, 2.1-2.5, 3.1-3.6, 4.1-4.5, 5.1-5.5_

- [x] 2.2 セッション中断・再開機能を実装する
  - セッション進行中に状態を自動保存する機能を実装する
  - アプリ起動時に中断セッションを検出する機能を実装する
  - 中断セッションを再開する機能を実装する（読み返しフェーズから再開）
  - 中断セッションを破棄して新規開始する機能を実装する
  - 書き出し中に中断された場合のそのラウンドのリセット処理を実装する
  - ストレージ読み込みエラー時の防御的処理を実装する
  - _Requirements: 7.1-7.5_

- [x] 2.3 セッション状態管理フックのテストを作成する
  - 初期状態が正しく設定されることをテストする
  - 繰り返し回数の変更と範囲バリデーションをテストする
  - セッション開始でフェーズが正しく遷移することをテストする
  - 書き出し完了でテキスト保存とフェーズ遷移をテストする
  - 読み返し完了でメモ追加とラウンド進行をテストする
  - 最終ラウンドでセッション完了になることをテストする
  - リセットで初期状態に戻ることをテストする
  - 中断セッションの保存・読み込み・破棄をテストする
  - _Requirements: 全要件のロジック検証_

- [x] 3. 設定画面コンポーネントを実装する
- [x] 3.1 繰り返し回数設定UIを実装する
  - 繰り返し回数を表示・変更できる入力フィールドを実装する
  - 回数の増減ボタンまたは直接入力を実装する
  - 1-99の範囲制限を入力時に適用する
  - セッション開始ボタンを実装する
  - アクセシビリティ対応（ラベル、キーボード操作）を実装する
  - _Requirements: 1.1, 1.3, 1.4, 8.3_

- [x] 3.2 設定画面のスタイルを実装する
  - モバイルファーストのレイアウトを実装する
  - 入力フィールドとボタンのタップ領域を最小44pxで実装する
  - デスクトップ向けの中央揃えレイアウトを実装する
  - フォーカス状態のスタイルを実装する
  - _Requirements: 8.3_

- [x] 3.3 設定画面のテストを作成する
  - デフォルト値が正しく表示されることをテストする
  - 回数変更が正しく反映されることをテストする
  - 開始ボタンクリックでコールバックが呼ばれることをテストする
  - 範囲外の値が制限されることをテストする
  - キーボード操作が動作することをテストする
  - _Requirements: 1.1-1.4_

- [x] 4. 中断セッション再開ダイアログを実装する
- [x] 4.1 再開確認ダイアログUIを実装する
  - 中断されたセッションの情報を表示する（ラウンド番号、総ラウンド数）
  - 「再開」ボタンを実装する
  - 「新規開始」ボタンを実装する
  - モーダルオーバーレイを実装する
  - フォーカストラップを実装する（ダイアログ外にフォーカスが出ないようにする）
  - Escapeキーでの閉じる操作を無効化する（明示的な選択を強制）
  - _Requirements: 7.2, 7.3, 7.4, 8.5_

- [x] 4.2 再開ダイアログのスタイルを実装する
  - オーバーレイの背景を半透明で実装する
  - ダイアログを中央に配置する
  - ボタンのレイアウト（モバイル：縦並び、デスクトップ：横並び）を実装する
  - アクセシビリティ対応のフォーカススタイルを実装する
  - _Requirements: 8.5_

- [x] 4.3 再開ダイアログのテストを作成する
  - 中断情報が正しく表示されることをテストする
  - 「再開」クリックでコールバックが呼ばれることをテストする
  - 「新規開始」クリックでコールバックが呼ばれることをテストする
  - フォーカストラップが機能することをテストする
  - _Requirements: 7.2-7.4, 8.5_

- [x] 5. セッション管理コンポーネントを実装する
- [x] 5.1 モード切替とフェーズ制御を実装する
  - 現在のフェーズに応じた表示切替を実装する（設定→書き出し→読み返し）
  - 書き出しモードコンポーネントへの状態渡しを実装する（autoStart、onComplete）
  - 読み返しモードコンポーネントへの状態渡しを実装する（text、currentRound、totalRounds、isLastRound、onNext）
  - 設定画面コンポーネントへの状態渡しを実装する（totalRounds、onChange、onStart）
  - 中断セッション再開ダイアログの表示制御を実装する
  - セッション完了時の親コンポーネントへの通知を実装する
  - _Requirements: 2.1-2.5, 6.1-6.5_

- [x] 5.2 セッション進行状態の管理と通知を実装する
  - 書き出し完了時のメモ保存と読み返しモードへの遷移を実装する
  - 読み返し完了時のメモ更新と次ラウンドへの遷移を実装する
  - 最終ラウンド完了時のセッション終了処理を実装する
  - セッション完了コールバックで全メモデータを渡す処理を実装する
  - _Requirements: 3.4, 3.5, 4.1-4.3_

- [x] 5.3 アクセシビリティ通知を実装する
  - モード切替時のスクリーンリーダー通知を実装する（aria-live）
  - セッション進行状況変更時の通知を実装する
  - セッション完了時の通知を実装する
  - スクリーンリーダー専用の非表示テキスト領域を実装する
  - _Requirements: 8.1, 8.2, 8.4_

- [x] 5.4 セッション管理コンポーネントのスタイルを実装する
  - 全画面レイアウトを実装する
  - コンテンツ領域の中央配置を実装する
  - レスポンシブ対応を実装する
  - _Requirements: 設計仕様_

- [x] 5.5 セッション管理コンポーネントのテストを作成する
  - 初期表示で設定画面が表示されることをテストする
  - 開始ボタンで書き出しモードに切り替わることをテストする
  - 書き出し完了で読み返しモードに切り替わることをテストする
  - 「次へ」クリックで書き出しモードに戻ることをテストする
  - 最終ラウンドで「完了」クリック後にコールバックが呼ばれることをテストする
  - 全メモデータがコールバックに渡されることをテストする
  - 中断セッション検出時にダイアログが表示されることをテストする
  - aria-live通知が正しく発生することをテストする
  - _Requirements: 2.1-2.5, 4.2, 4.3, 6.1-6.5, 7.2, 8.1-8.4_

- [x] 6. アプリ全体への統合を実装する
- [x] 6.1 アプリルートコンポーネントにセッション管理を統合する
  - 既存のTimerコンポーネント表示をセッション管理に置き換える
  - セッション完了時のハンドラを実装する（コンソールログまたは仮の完了画面）
  - 全体レイアウトの調整を行う
  - _Requirements: 4.2, 4.3_

- [x] 6.2 統合テストを作成する
  - 1ラウンドのセッションを開始から完了まで実行できることをテストする
  - 複数ラウンド（2-3回）のセッションを完走できることをテストする
  - 書き出しモードと読み返しモードの連携が正しく動作することをテストする
  - セッション完了後に全メモが取得できることをテストする
  - _Requirements: 全要件の統合検証_
